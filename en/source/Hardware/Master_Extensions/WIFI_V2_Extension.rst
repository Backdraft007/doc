
:breadcrumbs: <a href="../../index.html">Home</a> / <a href="../../index.html#hardware">Hardware</a> / WIFI Master Extension 2.0
:shoplink: ../../../shop/master-extensions/wifi-v2-master-extension.html

.. _wifi_v2_extension:

WIFI Master Extension 2.0
=========================

.. raw:: html

	{% tfgallery %}

	Extensions/extension_wifi2_tilted_[?|?].jpg         WIFI Extension 2.0
	Extensions/extension_wifi2_w_master_[100|800].jpg   WIFI Extension 2.0 with Master Brick in a stack
	Extensions/extension_wifi2_tilted_bottom_[?|?].jpg  WIFI Extension 2.0
	Extensions/extension_wifi2_hand_[100|800].jpg       WIFI Extension 2.0 in hand
	Extensions/extension_wifi2_top_[?|?].jpg            WIFI Extension 2.0 top
	Extensions/extension_wifi2_bottom_[?|?].jpg         WIFI Extension 2.0 bottom
	Dimensions/wifi_extension_dimensions_[100|600].png  WIFI Extension 2.0 dimensions

	{% tfgalleryend %}


Features
--------

* Controls Bricks/Bricklets wirelessly over a WIFI network
* Operates at 802.11b/g/n
* Supports WPA2 encryption as client and access point
* Supports static IP as well as DHCP as client and access point
* Supports client and access point mode at the same time


Description
-----------

With the WIFI Extension 2.0 you can control :ref:`Bricks <primer_bricks>` and
:ref:`Bricklets <primer_bricklets>` wirelessly over your
mobile phone, tablet or PC. For an explanation of the Master Extension
concept please take a look at the general :ref:`description <primer_master_extensions>`.

..
 The devices supports two modes. In Full Speed Mode the device Wi-Fi transceiver is always on.
 New incoming data will be immediately handled. In Low Power Mode the devices is not always on,
 the transceiver enters sleep mode after each message. This leads to a significantly lower power
 consumption and data throughput.

Since the device itself handles TCP/IP packages generated by the API, it is possible to
connect directly from your controlling device (mobile phone, tablet, (embedded) PC).
A :ref:`Brick Daemon <brickd>` is not necessary.

To use the WIFI Extension 2.0 a :ref:`Master Brick <master_brick>` is mandatory.
The :ref:`RED Brick <red_brick>` is currently not supported.
If you want to use other Bricks, you can build a :ref:`stack <primer_stack>`
and plug them also on top of the Master Brick. If you want to use Bricklets you
can attach them to the Master Brick or to other Bricks in the stack. From the
programming perspective this is completely transparent, i.e. all Bricks and
Bricklets can be used exactly the same way as if they were connected to your
controlling device via USB.

You need a Master Brick with firmware version 2.4.0 or newer to use this
extension.

The following combinations with other Extensions in a stack are possible
(regardless of order):

* WIFI 2.0 / RS485 Master

Technical Specifications
------------------------

================================  =============================================================================
Property                          Value
================================  =============================================================================
Current Consumption               80mA (transmit), TBDmA (during sleep)
--------------------------------  -----------------------------------------------------------------------------
--------------------------------  -----------------------------------------------------------------------------
Maximum Concurrent Connections    10
Modes                             Client, Access Point and Client/Access Point concurrently
Tinkerforge Protocols             Full support (TCP/IP, authentication and WebSockets)
--------------------------------  -----------------------------------------------------------------------------
--------------------------------  -----------------------------------------------------------------------------
RF Output Power (Typical)         up to 19.5dBm
Security Protocols                WPA, WPA2
Supported Standards               IEEE 802.11 b/g/n, with CCK, OFDM and MCS7 modulation
--------------------------------  -----------------------------------------------------------------------------
--------------------------------  -----------------------------------------------------------------------------
Dimensions (W x D x H)            40 x 40 x 16mm  (1.57 x 1.57 x 0.63")
Weight                            12g
================================  =============================================================================


Resources
---------

* ESP-WROOM-02 (`Homepage <https://espressif.com/en/products/hardware/esp-wroom-02/overview>`__)
* Schematic (`Download <https://github.com/Tinkerforge/wifi-v2-extension/raw/master/hardware/wifi-extension-schematic.pdf>`__)
* Outline and drilling plan (`Download <../../_images/Dimensions/wifi_extension_dimensions.png>`__)
* Source code and design files (`Download <https://github.com/Tinkerforge/wifi-v2-extension/zipball/master>`__)


WIFI Network
------------

With this Master Extension you will be able to create a wireless connection to
a Master Brick and all of its connected Bricks and Bricklets.
A Brick Daemon is not required.

If you want to connect the Brick Viewer with your WIFI setup,
you have to enter the IP of the WIFI Extension 2.0 and the configured port
in the Setup Tab. After pressing "Connect" you will not connect to your local
running Brick Daemon but to your WIFI Extension 2.0.

.. image:: /Images/Extensions/extension_wifi_brickv.jpg
   :scale: 100 %
   :alt: Brick Viewer configration for WIFI Extension 2.0
   :align: center
   :target: ../../_images/Extensions/extension_wifi_brickv.jpg

For your own code modify the host and port in your ``connect`` call, e.g.:

.. code-block:: python

 ipcon.connect("localhost", 4223)

has to be changed to

.. code-block:: python

 ipcon.connect("192.168.0.25", 4223)


WIFI Configuration
------------------

You can configure the WIFI Extension 2.0 through the Master Brick Tab in the
Brick Viewer.

.. image:: /Images/Extensions/extension_wifi2_brickv_complete.jpg
   :scale: 100 %
   :alt: Complete brickv Master Brick tab
   :align: center
   :target: ../../_images/Extensions/extension_wifi2_complete.jpg

.. _wifi_v2_extension_ports:

Ports
^^^^^

The first configuration options are the port, WebSocket port and website port.
You can change them from the defaults 4223, 4280 and 80 if necessary. In most
cases they can stay unchanged.

.. image:: /Images/Extensions/extension_wifi2_brickv_ports.jpg
   :scale: 100 %
   :alt: WIFI Extension 2.0 port configuration
   :align: center
   :target: ../../_images/Extensions/extension_wifi2_ports.jpg

PHY Modes
^^^^^^^^^

The PHY modes

* B,
* G and
* N

are available. PHY mode N can't be used if the access point is enabled.

.. image:: /Images/Extensions/extension_wifi2_brickv_phy_mode.jpg
   :scale: 100 %
   :alt: WIFI Extension 2.0 phy mode configuration
   :align: center
   :target: ../../_images/Extensions/extension_wifi2_phy_mode.jpg

.. _wifi_v2_extension_authentication:

Authentication
^^^^^^^^^^^^^^

The WIFI Extension 2.0 supports authentication. Authentication is disabled by
default. Tick the "Use
Authentication" check box and choose an authentication secret to enable it.
This secret can be 64 ASCII characters long. After saving the configuration
and restarting the Master Brick authentication is enabled.

.. image:: /Images/Extensions/extension_wifi2_brickv_authentication.jpg
   :scale: 100 %
   :alt: WIFI Extension 2.0 phy authentication configuration
   :align: center
   :target: ../../_images/Extensions/extension_brickv_wifi2_authentication.jpg

Now every TCP/IP connection to the WIFI Extension 2.0 has to prove to the
Master Brick that it knows the authentication secret before normal communication
can occur. See the :ref:`authentication tutorial <tutorial_authentication>`
for more information.

Operational Modes
^^^^^^^^^^^^^^^^^

The WIFI Extension 2.0 can operate as

* Client,
* Access Point or
* both at the same time.

.. image:: /Images/Extensions/extension_wifi2_brickv_mode.jpg
   :scale: 100 %
   :alt: WIFI Extension 2.0 phy mode configuration
   :align: center
   :target: ../../_images/Extensions/extension_wifi2_brickv_mode.jpg

If you choose both, the two resulting networks are completely
independent from each other. The Client will have a different MAC as the
Access Point and there is no routing between the networks.

The whole configuration (including client and access point configuration) is
saved by pressing the "Save WIFI Configuration" button at the bottom.

To see the current status of the WIFI Extension 2.0 press the "Show Status"
button.

Client Mode Configuration
-------------------------

In client mode you can set a hostname with up to 32 ASCII characters.

.. image:: /Images/Extensions/extension_wifi2_brickv_client_hostname.jpg
   :scale: 100 %
   :alt: WIFI Extension 2.0 client hostname configuration
   :align: center
   :target: ../../_images/Extensions/extension_wifi2_brickv_client_hostname.jpg

The IP can be obtained using DHCP or you can choose to use a static IP.
In the latter case you have to configure a IP, subnet mask and gateway.

.. image:: /Images/Extensions/extension_wifi2_brickv_client_ip.jpg
   :scale: 100 %
   :alt: WIFI Extension 2.0 client IP configuration
   :align: center
   :target: ../../_images/Extensions/extension_wifi2_brickv_client_ip.jpg

The SSID of the access point can be up to 32 ASCII characters long.

.. image:: /Images/Extensions/extension_wifi2_brickv_client_ssid.jpg
   :scale: 100 %
   :alt: WIFI Extension 2.0 client SSID configuration
   :align: center
   :target: ../../_images/Extensions/extension_wifi2_brickv_client_ssid.jpg

It is possible to connect to open networks as well as networks encrypted
by WPA/WPA2.

.. image:: /Images/Extensions/extension_wifi2_brickv_client_encryption.jpg
   :scale: 100 %
   :alt: WIFI Extension 2.0 client encryption configuration
   :align: center
   :target: ../../_images/Extensions/extension_wifi2_brickv_client_encryption.jpg

If your network is encrypted you can set a password with up to 64
ASCII characters.

If necessary you can specify a specific BSSID that you of a Access Point
that you want to connect to and you can use a custom MAC address.

.. image:: /Images/Extensions/extension_wifi2_brickv_client_bssid_mac.jpg
   :scale: 100 %
   :alt: WIFI Extension 2.0 client BSSID and MAC configuration
   :align: center
   :target: ../../_images/Extensions/extension_wifi2_brickv_client_bssid_mac.jpg

Access Point Mode Configuration
-------------------------------

In Access Point mode you can either enable DHCP (the WIFI Extension 2.0 will run
a DHCP server) or static IP. If you choose static IP, please make sure that
the client uses a IP, subnet mask and gateway which is compatible to the
static WIFI Extension 2.0 network.

.. image:: /Images/Extensions/extension_wifi2_brickv_ap_ip.jpg
   :scale: 100 %
   :alt: WIFI Extension 2.0 AP IP configuration
   :align: center
   :target: ../../_images/Extensions/extension_wifi2_brickv_ap_ip.jpg

The SSID can be up to 32 ASCII characters long.

.. image:: /Images/Extensions/extension_wifi2_brickv_ap_ssid.jpg
   :scale: 100 %
   :alt: WIFI Extension 2.0 AP SSID configuration
   :align: center
   :target: ../../_images/Extensions/extension_wifi2_brickv_ap_ssid.jpg

In Access Point mode the WIFI Extension 2.0 supports

* WPA PSK,
* WPA2 PSK and
* WPA/WPA2 PSK

as encryption protocols. You can also open a network without encryption.
If you enable encryption you can set a password with up to 64 ASCII characters.

.. image:: /Images/Extensions/extension_wifi2_brickv_ap_encryption.jpg
   :scale: 100 %
   :alt: WIFI Extension 2.0 AP encryption configuration
   :align: center
   :target: ../../_images/Extensions/extension_wifi2_brickv_ap_encryption.jpg

Additionally you can specify a WIFI channel between 1 and 13, hide the SSID and
use a custom MAC address.

.. image:: /Images/Extensions/extension_wifi2_brickv_ap_channel_hide_ssid_mac.jpg
   :scale: 100 %
   :alt: WIFI Extension 2.0 AP channel, hide SSID, and MAC configuration
   :align: center
   :target: ../../_images/Extensions/extension_wifi2_brickv_ap_channel_hide_ssid_mac.jpg


Web Interface
-------------

Starting from the firmware version 2.0.1 a web interface is available for configuring
the extension. With this interface the current status of the extension can be viewed
and the configuration options as discussed in the previous section can be configured.

.. image:: /Images/Extensions/extension_wifi2_web_interface_status.jpg
  :scale: 100 %
  :alt: Status view of the web interface of WIFI Extension 2.0
  :align: center
  :target: ../../_images/Extensions/extension_wifi2_web_interface_status.jpg

The "Disable Web Interface" check box in the settings view can be used to enable
or disable the web interface. When the web interface is disabled it can be enabled
from Brick Viewer. Note that to disable the web interface in Brick Viewer 2.3.6
the "Website Port" field must be set to 1. Setting this field to a value which is
greater than 1 will enable the web interface on the corresponding port. From Brick
Viewer version 2.3.7 this is fixed and a check box is available like in the web
interface for enabling or disabling the web interface.

.. image:: /Images/Extensions/extension_wifi2_web_interface_settings.jpg
  :scale: 100 %
  :alt: Settings configuration view of the web interface of WIFI Extension 2.0
  :align: center
  :target: ../../_images/Extensions/extension_wifi2_web_interface_settings.jpg

If authentication secret is enabled then the web interface will present the following
page for user authentication.

.. image:: /Images/Extensions/extension_wifi2_web_interface_authentication.jpg
  :scale: 100 %
  :alt: Authentication view of the web interface of WIFI Extension 2.0
  :align: center
  :target: ../../_images/Extensions/extension_wifi2_web_interface_authentication.jpg


Mesh
----

Starting from the firmware version 2.0.4 the WIFI extension 2 supports mesh mode.
Note that for using the mesh feature properly, Master Brick firmware version
2.4.2 or higher, Brick Daemon version 2.2.4 or higher and Brick Viewer version
2.3.7 or higher is required.

Stacks with WIFI extension 2 which are configured in mesh mode can form a mesh
network. All the devices present in these stacks can be accessed normally.

Some key concepts of mesh mode are:

* Mesh Root Node
* Mesh Router
* Mesh Gateway

Each mesh network has at least one root node. Root nodes are entry/exit point of
the mesh network where data is coming into the the mesh network or going out of
the mesh network.

Mesh router is a WIFI access point to which the root node connects to reach the
mesh gateway.

The mesh gateway is basically Brick Daemon which can handle and route data coming
from the nodes of a mesh network and can also send data into mesh network.

The illustration below represents a simple scenario to understand the system better.

.. image:: /Images/Extensions/extension_wifi2_mesh_example.jpg
  :scale: 100 %
  :alt: Example topology of mesh usage
  :align: center
  :target: ../../_images/Extensions/extension_wifi2_mesh_example.jpg

In the illustration above, there is a mesh network with five stacks each with
a WIFI Extension 2 configured in mesh mode. The root node of this mesh network
is marked with a red circle. The mesh root node can connect to the WIFI access
point, "Mesh Router". The "Brick Daemon" machine is running a Brick Daemon that
supports mesh feature and is reachable via the same network of the "Mesh Router".
From the perspective of the mesh network this machine is the mesh gateway.

The mesh root node establishes a connection to the mesh gateway which is marked
with the green lines in the illustration. After that, all the stacks which are
available in the mesh network are accessible to the "Client" which is connected
to the Brick Daemon that is running on the "Brick Daemon" machine. This connection
is marked with the blue lines in the illustration.

Configuration
^^^^^^^^^^^^^

Every mesh WIFI Extension 2 that is member of a particular mesh network has
identical configuration.

To form a mesh network first the extension must be configured to be in mesh mode.
This can be achieved from Brick Viewer by selecting mesh mode.

.. image:: /Images/Extensions/extension_wifi2_mesh_mode.jpg
  :scale: 100 %
  :alt: Example topology of mesh usage
  :align: center
  :target: ../../_images/Extensions/extension_wifi2_mesh_mode.jpg

Mesh router configuration must be provided to the node. These are generic
configuration parameters that are required to configure and connect to a WIFI
access point.

.. image:: /Images/Extensions/extension_wifi2_mesh_router.jpg
  :scale: 100 %
  :alt: Example topology of mesh usage
  :align: center
  :target: ../../_images/Extensions/extension_wifi2_mesh_router.jpg

It must be defined to which mesh network a mesh node belongs to. The
"Group SSID Prefix" and "Group ID" together defines a mesh network to which
the mesh node belongs to. The "Mesh Gateway IP" and "Mesh Gateway Port" fields
define how the mesh gateway can be reached.

.. image:: /Images/Extensions/extension_wifi2_mesh_group.jpg
  :scale: 100 %
  :alt: Example topology of mesh usage
  :align: center
  :target: ../../_images/Extensions/extension_wifi2_mesh_group.jpg

Known Bugs
^^^^^^^^^^

* Mesh router SSID maximum length:

  The maximum applicable mesh router SSID can be 32 characters long but in mesh
  mode a mesh router SSID of upto 31 characters is valid. This is due to a bug
  in the Espressif mesh library.

* Dropped packets in non-root mesh node:

  This bug is also in the Espressif mesh library. If a mesh node which is not a
  root node receives a burst of packets all of these packets are dropped. This is
  rather a serious bug as it involves data loss. This bug can be easily observed
  by sending a lot of setter requests to a non-root mesh node and they will have
  timeouts. Because of this bug, Servo Brick's test feature which is offered by
  Brick Viewer will fail if the node where the Servo Brick is present is not a
  mesh root node.

  One work around of this problem is to limit the setter call burst, for example
  by setting response expected flag of the setter calls or by simply adding a
  slight delay between the setter calls.


LEDs
----

The blue power LED will be on permanently as long as the device is powered.
The green LED is a status LED.

In client mode it will blink fast while trying to connect to a access point and
turn on if connected.

In access point mode it will blink slowly as long as no client is connected.

If both are enabled, it will blink fast until it is connected to an external
access point and after that it will blink slowly until a client connects to the
access point of the WIFI Extension 2.0.

In mesh mode if the node is trying to establish a connection then the green LED
will blink rapidly. Once connection is established and the node is operational,
the green LED will blink slowly with an interval of about 6 seconds.


Programming Interface
---------------------

See :ref:`Master Brick documentation <master_brick_programming_interface>`.
